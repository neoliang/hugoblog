---
title: 光线追踪与蒙特卡洛
date: "2020-04-11"
url: "/posts/ray_tracing"
description: "为什么光线追踪会出现噪点，为什么需要蒙特卡洛？"
thumbnail: "preview_images/thumbs/ray_tracing.jpg"
image: "img/ray_tracing/head.jpg"
classes:
- feature-figcaption
- feature-figcaption-hidden
- feature-math
- feature-ace
categories:
- ray tracing
- 知乎
---
本文为我在知乎的回答[^1]

>为什么光线追踪会出现噪点，为什么需要蒙特卡洛？
光线追踪，按照原理来说，是逐个像素进行判断，那么有没有打到物体应该是个确定的事件，为什么我看到很多光线追踪一遍下来，圆形中间也会有白色噪点？这是怎么形成的？蒙特卡洛是怎么实现填补这些噪点的？

<!--more-->
[^1]:(https://www.zhihu.com/question/316017757/answer/734474715)

---

最近正在学习光线追踪，在这里谈谈对噪点的理解。

## 一、光线追踪是不是一定会出现噪点?

首先光线追踪是不是一定会出现噪点呢？答案是并不一定，比如下面这三张图都是我用光线追踪算法生成的，左边的图没有任何噪点、中间的图有大量的噪点，右边图有少量不明显噪点。左边图是我一开始还不太了解光线追踪时自己瞎搞的光线追踪器生成的，虽然图中并没有任何噪点，但是看起来极不自然、真实；中间和右边图是基于路径追踪算法生成，看起来比较接近真实，但是中间的图由于采样不足导致出现大量的噪点。生成三幅图的算法在上层光线生成部分是相同的，主要的差别是光照计算方式和每个象素的采样数量。左图采用phong光照模型，只追踪计算了镜面反射的光线路径积分，每个象素只做了一次采样；而中间和右图采用的是BRDF既计算了镜面反射也计算了漫反射的光线路径积分，但是生成这两幅图时每个象素的采样数量不同，中间的图是10，而右边的图是1000。

![光线追踪渲染对比](/img/ray_tracing/simple_tracing.jpg)

>光线追踪，按照原理来说，是逐个像素进行判断，那么有没有打到物体应该是个确定的事件，为什么我看到很多光线追踪一遍下来，圆形中间也会有白色噪点？

虽然逐象素发出光线、光线是否与物体相交是确定的，但是仅有相交信息并不能计算出该点的颜色。那么光线与物体表面交点的颜色该如何计算呢？现代光线追踪或光栅化渲染一般都通过求解渲染方程而得到交点的颜色。
渲染方程： {{<math>}}L_{o}(p,w_{o})=L_{e}(p,w_{o})+\int_{\Omega}f_{r}(p,w_{i}\rightarrow w_{o})L_{i}(p,w_{i})cos\theta dw_{i}{{</math>}}

该方程的物理意义是某p点的出射光颜色等于该点自发光的颜色加上反射颜色，而反射颜色等于该点所有入射光线的某种分布，这里入射光线指因镜面反射、折射和漫反射产生的光线。

## 二、噪点是如何产生的？

**产生噪点主要有两个原因，积分过程中光线采样不足及生成入射光线样本与真实光线的分布有偏差。**

在光线追踪过程中，如果能精确的求解出渲染方程，算出每个点的反射颜色，那么渲染出的图片接近真实照片，不会出现噪点。在求解方程的过程中，对于每个点反射光线的颜色是自发光颜色+反射光颜色，对于自发光部分一般为一个常数值，而反射部分则是一个半球上的积分计算。对于理想镜面反射，光线的反射只在一个方向上有值，并不需要生成很多样本去做积分运算，可以做特殊处理，但是对于漫反射部分，如果要精确的计算出结果，则需在对入射到该点的半球面上的所有光线做积分运算，而直接求解该方程的积分比较困难，在实际光线追踪应用中则是使用蒙特卡罗的方式近似求解。而在积分过程中需要采样大量的光线样本才能让积分收敛接近真实值，如果采样不足或者生成的光线样本分布与真实光线的分布存在偏差就可能会出现噪点。

## 三、如何填补这些噪点？

噪点是因为采样引起的，因此我们可以改进采样来降低它，其中改进采样最简单有效的解决办法是提高光线采样数量，对于路径追踪来说，就是提高每个像素点随机生成的光线路径数量。但是提高采样数量一方面会增加计算时间，另一方面采样数量与噪点收敛并不成线性比例，采样数量提高到一定程度后，噪点降低的幅度变化很小。如下图[^2] 是每个象素不同的采样数量下使用路径追踪生成的图片对比，从左到右分别对应的每个象素采样为1、16、256、4096、65536，可以看到，随时采样数量的提高，噪点变得越来越少。但是如果放大来看，就算采样为4096的图片上也会有噪点。
![不同采样数量路径追踪生成的图片对比](/img/ray_tracing/noise.jpg)
另外一种改进采样的方法是重要性采样（Importance Sampling），由于均匀采样（Uniform Sampling）生成的光线样本在各个方向上概率都相同，并不会对灯光特殊对待。在实际应用中，如果能让随机生成的光线样本有极大的概率偏向灯光的方向也可以减少噪点。为了防止对灯光的过度采样，我们还需要对采样的结果用概率密度函数(pdf-probability density function​ )做权值调整。这种非均匀采样，再对采样结果用pdf加权调整的方式叫重要性采样。下图展示了路径追踪采用均匀采样、灯光重要性采样及混合均匀采样与灯光重要性采样生成图片的对比，最左边是均匀采样、采样数量为400，中间是区域灯光重要性采样，采样数量是10，最右边是混合了区域灯光采样与均匀采样，采样数量为400。从图上可以看出，在同样采样数量下，均匀采样比重要性采样生成的图噪点更多，另外、灯光重要性采样虽然在较低的采样数量下生成的图片噪点很少，但是生成的图片并不真实，最明显的是中间图的天花板和两个箱子的暗面为纯黑色，效果并不是很好。
![不同采样方法的光线追踪对比](/img/ray_tracing/sample.jpg)

另外除了改进光线采样外，还可以对最终生成的图像做后期处理以实现降噪，比如一个简单的办法是对采样生成的图像做双线性插值。
大量的采样耗时较高，最近在光线追踪领域研究得比较多的是去噪算法（Denoising），在 @文刀秋二 的这篇文章中有提过[^2] ，即通过Denoising算法，将极低采样的光线追踪结果重建（Reconstruct）出非常接近用大量采样渲染得到的收敛后的图像。

[^2]:(http://www.realtimerendering.com/Real-Time_Rendering_4th-Real-Time_Ray_Tracing.pdf)
[^3]:(https://zhuanlan.zhihu.com/p/34851503)
