---
title: 光与影（0）-开篇	
date: "2021-10-24"
url: "/posts/light_shadow1"
description: "讲述光照的计算"
thumbnail: "preview_images/thumbs/ray_tracing.jpg"
image: "img/ray_tracing/head.jpg"
classes:
- feature-figcaption
- feature-figcaption-hidden
- feature-math
- feature-ace
categories:
- 光照
- 阴影
---
光与影像是一对孪生兄弟，有光的地方一定会有影，有影的地方一定会有光。光是什么，它是怎么传输的，什么是颜色，人眼是怎么感知颜色的？这些问题一直困扰着人类。或许从人类有记忆时开时，就有了对光思考和探索，它蕴含着浩瀚宇宙的奥秘，启发了艺术、宗教及科学。千百年来，这个地球上无数颗聪明的头脑被光神秘的气质所吸引，试图解开它的奥秘，特别地在物理学领域，有数十个诺贝尔获奖者诞生于对光的本质的研究和探索过程中。
<!--more-->

## 什么是光

什么是光，这问题并不好回答？2000多年前希腊数学家欧几里得曾提出我们之所以能看到东西是因为眼睛发出了光然后感受到了物体的存在，在今天看来，这个理论显得有些幼稚和可笑。但历史上对光生产过误解的科学家可以不止欧几里得一个人，甚至包含牛顿。牛顿曾经认为光的折射现象是因为从空气传播到水中受到某种力，产生加速导致的。
要真正理解光的本质，需要理解几何光学，电磁学，甚至量子力学。在计算机渲染领域中，人们比较关心光的传输（例如反射、折射与散射等）及对光的视觉显示（这涉及到颜色的表示、物体的材质等）。1986年kajiya就提出了渲染方程[^1]，从物理学的角度准确的描述光线的传输及光与物体表面的作用，但要正确的求解出渲染方程实现真实的光照效果还比较困难。一方面渲染方程是一个多维积分，基本无法以直接求出通解，只能近似求解，例如路径追踪，仍受限于图形处理机的算力，直到近几年才在实时渲染领域有所应用；另一方面很难找到精确通用的物体材质表达方式，虽然人们提出过lambert、blin-phon等模型，但这些大多数是基于经验，需要艺术家对参数调校，并不能准确描述光照效果，很达到标准化，在游戏开发中，给工业化生产障碍，例如一个游戏关卡场景，美术好不容易花几天时间调整好了白天的光照效果，但当切换到夜晚时，有可能还得再根据经验调整一次，这无疑提高了游戏的制作成本。2014年迪士尼提出了一种基于微表面模型的PBR[^2]，该方法只需要通过一些简单的参数，例如金属度、粗糙度等就可以描述出大多数材质，从物理学的角度上更真实的描述了物体的材质属性，使得光照计算更加可控，而这个模型的计算开销并不大，如今已经被大多数游戏引擎例如unreal与unity使用。

[^1]:(http://www.cse.chalmers.se/edu/year/2011/course/TDA361/2007/rend_eq.pdf)
[^2]:(https://media.disneyanimation.com/uploads/production/publication_asset/48/asset/s2012_pbs_disney_brdf_notes_v3.pdf)

## 光照的计算

求解渲染方程是比较困难的，在离线渲染领域，可以使用光线追踪这样比较精确但计算复杂度较高的算法来实现，例如路径追踪。而在实时渲染领域，大多是采用一些计算复杂度比较低的技巧来近似，这些方法大多数只考虑了光照或者阴影，例如著名的球谐光照、unreal的split-sum方法就是光照效果近似，而shadowmap、ssao就是对阴影的近似，在实时渲染领域中通常会将上述的多种方法一起使用来实现真实的光照效果。

## 颜色

### Gamma空间

颜色并不容易理解，涉及到物理学、生物学甚至心理学。《费曼物理学》[^3]对颜色从多个维度上给出了很好的解释，pbr-book也给出了光谱的描述及光谱与和颜色的转换[^4]。在计算机图形学中，我们一般使用RGB三个数值来描述颜色，那么这三个数值该如何对应到颜色的视觉上呢？现在网页、显示器和打印机的显示标准是微软与惠普在1996年定义的srgb标准[^5]，srgb现在已经得到了W3C、Exif、英特尔、Pantone、Corel以及其它许多业界厂商的支持。
该标准表示的颜色的明暗是非线性的，暗部会占用更多的数值段，例如rgb数值(0.4,0.4,0.4)与(0.8,0,8,0.8)表示的颜色虽然在数值上后者是前者的2倍，但在srgbs标准下显示出来，后者的强度并是不是前者的2倍，这种表示方法gamma空间下的颜色表示方法。如果表示光的强度的颜色的明暗也采用非线性表示，那么计算结果将会是错误的。比如降噪常用的模糊算法，涉及到求像素的平均值，如果采用非线性表示，模糊的后的图片看起来会显得有些发黑。如下图，左边是在线性空间的模糊右边是在线性空间的模糊。

另一个简单的例子是shader中的颜色混合mix函数，如下是红色与绿色从左到右按权重混合的对比，图片的上半部分是在gamma空间，下半部分在线性空间，可以这两者的显示效果差异很大。

{{<shader height=480 hideCode=true >}}
void mainImage(out vec4 fragColor, in vec2 fragCoord)
{    
    vec2 uv = fragCoord/iResolution.xy;
    vec3 color = mix(vec3(1,0,0),vec3(0,1,0),uv.x);
    if(uv.y < 0.5) color = sqrt(color);
	fragColor = vec4(color, 1.0);
}
{{</shader>}}
在计算光照计算时，如果颜色在gamma空间，那么结果可能看起来过爆光过度，也有可能看起来光照不足，很难通过调整光照或材质来达到线性空间下的光照效果。如下是一个光照在gamma和线性空间下的对比：

### 为什么要使用Gamma空间

至于为什么颜色的要采用Gamma空间表示，网上有很多传说，有从摄形图片存储的角度来解释的，也有从人眼对明暗细节的敏感角度来解释的，想要追根朔源是一件比较头疼的事。我想标准的定制大多数和当时的历史条件有关，有可能是受限于硬件显示性能，也有可能是受限于数值表示的精度，才采用了这srgb这种标准，这些原因都已经不重要了，对于渲染来说，我们直需要知道srgb格式如何转换为明暗与数值成正比的线性的表示即可，即如何将gamma空间转换到线性空间及相反的转换。

### 线性空间与Gamma空间的转换

[^3]:(https://www.feynmanlectures.caltech.edu/I_35.html)
[^4]:(https://www.pbr-book.org/3ed-2018/Color_and_Radiometry/The_SampledSpectrum_Class)
[^5]:(https://en.wikipedia.org/wiki/SRGB)


## 漫反射

在光照的计算中，最简单的或许是漫反射的计算了，漫反射是指一个点从任意角度观察都相同，观察到的出射光照的强度与入射光强度及入射光方向与法线的夹角余弦成正比，用公式来描述：{{<math>}} L_o=L_i*cos(\theta) = L_i*\vec l \cdot \vec n {{</math>}}

## 阴影

- sdf下的软阴影
- shadowmap
	- pcf
	- pcss
	- vsm

## 环境光

## 高光

