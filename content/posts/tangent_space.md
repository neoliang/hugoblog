---
title: 切线空间
date: "2020-01-01"
url: "/posts/tangent_space"
description: "为什么要有切线空间（Tangent Space），它的作用是什么？"
thumbnail: "preview_images/thumbs/tangent_coord.jpg"
classes:
- feature-figcaption
- feature-figcaption-hidden
- feature-math
- feature-ace
categories:
- portfolio
- physics
---

本文为我在知乎的回答[^1]

>为什么要有切线空间（Tangent Space），它的作用是什么？
新手，有好多不明白的地方：

>1.法线贴图（Normal map）技术中的切线空间是一个怎样的空间？

>2.法线贴图上存储的值是什么值？这个值是如何计算得到的？

>3.转换到Tangent space时，[n.x,n.y,n.z] [T, B ,N] 与 [n.x,n.y,n.z] [B, T ,N] 有什么区别？

为什么要有切线空间？这得先从法线贴图说起

## 一、什么是法线贴图？

顾名思义，法线贴图就是保存了3D模型表面法线的贴图，主要用途是为了让3D模型在接收光照时显得更加真实。例如下图演示的是同一个3D模型在Unity中有法线贴图和无法线贴图所接收到的光照渲染对比，左右两边分别对应的是无法线贴图和有法线贴图的效果，很明显有法线贴图的黑叔叔脸部细节更丰富、刀疤更清晰，脖子上的肌肉细条相对于左图也要更清晰和立体一些。

<!--more-->
[^1]:(https://www.zhihu.com/question/23706933/answer/958094336)

![法线贴图对比](/img/tangent_space/normal.jpg)


## 二、什么是切线空间？

我们知道，一个法线向量有三个坐标值 (x,y,z) ，这个值是相对于哪个坐标系下的呢？我们可以选择3D模型的顶点所在的坐标系，即对象空间(Object-Space)，也可以选择3D模型纹理所在的坐标系，即切线空间(Tangent-Space)，也称为纹理空间(Texture-Space)。例如下图是两张不同坐标系下的法线贴图对比，你能分辨出哪一张是切线空间中法线贴图吗？ 
![对象空间法线贴图与切线空间法线贴图](/img/tangent_space/normal1.jpg)
其实，切线空间中的法线贴图特征比较明显，颜色比较单调，整体偏蓝色。为什么呢？因为法线贴图中任意一点的颜色通道的b值都大于0.5。为什么？在回答这个问题之前，我们先来了解一下什么是切线空间，切线空间可以理解为对于在3D模型表面上的任意一个点，在该点切平面上选取两条相互垂直的坐标轴以及切平面的法线所组成的坐标系。我们来举个简单的例子，假设地球是一个巨大的3D球模型，对于地球的任意一点P我们选择该点的由南向北方向为x坐标轴(T)，由西向东方向为y坐标轴(B)，地心与该点的连线方向为z坐标轴(N)，这样的坐标系称为该点的切线空间。
![对象空间法线贴图与切线空间法线贴图](/img/tangent_space/tangent_coord.jpg)

可以看到，**切线空间中任意一点的法线与N坐标轴的夹角小于90度，也就是说法线的z值大于0。在归一化之后，法线的x和y取值范围为[-1,1],而z的取值范围为[0,1]。通常情况下我们存储在贴图中的值为正，一般通过一个简单的变换 pixel=(normal+1)/2 来完成，经过该变换后，z的取值范围变为[0.5,1],所以切线空间下的法线贴图整体偏蓝。**

## 三、切线空间有什么优缺点？
上一节中提过，对象空间中的法线和3D模型的顶点在一个空间，因此我们把这样的法线贴图应用到3D模型的另外一个部分或者另外一个3D模型上，解析出来的法线值可能就不对了，而切线空间中的法线与纹理坐标在同一空间，也就说只要我们同时将漫反射等纹理贴图和法线贴图同时应用到另一个模型上，法线贴图中的值经过变换后依然是正确的。如下图 
![切线空间中的法线贴图与对象空间的法线贴图光照对比](/img/tangent_space/lighting.jpg)

左图是切线空间中的法线贴图计算出来的光照，地板和墙的光照都是正确的。而右图的法线贴图在墙的对象空间中，地板在复用了墙的法线贴图后，计算出来的光照是错误的。

### 那么切线空间中的法线贴图有什么缺点呢？

由于在计算光照时需要统一法线和光照方向所在的空间，我们需要将切线空间的法线变换到灯光的空间（世界空间或者对象空间）或者将灯光从其所在的空间变换到切线空间，而空间变换需要计算额外的旋转矩阵TBN，一般情况下我们在vertex shader中计算TBN，再将灯光变换到切线空间，之后再将相关信息传递到fragment shader中，这样相对于对象空间中的法线贴图来说，在vertex shader中增加了额外矩阵运算，另外经过变换后每个象素的光照信息也变得不同，需要将这部分信息传递到fragment shader中。


## 四、法线贴图如何生成？
方法一，通过高度图生成，原理比较简单，对纹理中的任意一点求出u、v方向上的高度向量，叉乘后即可得到法线向量，例如下图 ，左边是高度图，右边是根据高度生成的法线贴图。
![缓过高度图生成法线贴图](/img/tangent_space/heightmap.jpg)
方法二，在maya等3D建模软件建立高精度模型，添加更丰富的细节然后再将法线贴图烘焙导出。

最后一个问题：

>3.转换到Tangent space时，[n.x,n.y,n.z] [T, B ,N] 与 [n.x,n.y,n.z] [B, T ,N] 有什么区别？

TBN其实只是一个约定，一般在生成切线空间的中法线贴图时以u方向为T,v方向为B。我们在渲染时，会根据生成法线的算法建立TBN矩阵。如果在生成时[n.x,n.y,n.z]对应的是 [T, B ,N]，那么我们在建的就是TBN矩阵，反之如果 [n.x,n.y,n.z] 对应的是[B, T ,N] 那么建立的就是BTN矩阵。
