{{ $id := delimit (shuffle (seq 1 9)) "" }}
{{ $editor_id := printf "editor_%s" $id }}
{{ $code_height := or (.Get "code-height") 360 }}
{{ $height := or (.Get "height") 360}}


<div id="{{$id}}"  style="max-width: 100%; height: 360px;"> </div>
<br>
<div id="parent_{{$editor_id}}" /> </div>
<script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/p5.js"></script>


<script type="text/javascript">
  let run_{{$id | safeJS}} = createAceEditor({
    parent :$("#parent_{{$editor_id}}"),
    id:"{{$editor_id}}",
    height:{{$code_height}},
    code:{{ .Inner }},
    onCodeWillRun:(code)=> 
    {
      $("#{{$id}}").children().remove();
      var scale = {{$height}}/720;
      var mapElement = $('#{{$id}}')
      var height = mapElement.width() * scale;
      
      mapElement.css("height",height);
      return "let last_sketch_{{$id}} = null;let width =" + mapElement.width() + ";let height = " +height+";let sketch_{{$id}} = (sketch)=>{last_sketch_{{$id}} = sketch;sketch.setup =()=>{var canvas = sketch.createCanvas(" + mapElement.width() +"," + height + ");" + code + "}}; if(last_sketch_{{$id}} !== null){last_sketch_{{$id}}.remove();}p5_{{$id}} = new p5(sketch_{{$id}},'{{$id}}');";
    }
    //onCodeRunEnd : ()=>{new p5();}
  })
  window.addEventListener("resize",run_{{$id | safeJS}});
</script>