
{{ $id := delimit (shuffle (seq 1 9)) "" }}
{{ $editor_id := printf "editor_%s" $id }}
{{ $code_height := or (.Get "code-height") 360 }}
{{ $height := or (.Get "height") 360}}


<div id="{{$id}}"  style="max-width: 100%; height: 360px;"> </div>
<br>
<script src="http://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.6/p5.js"></script>


<style type="text/css">
  
.caret {
  text-align: left;
  cursor: pointer;
  -webkit-user-select: none; /* Safari 3.1+ */
  -moz-user-select: none; /* Firefox 2+ */
  -ms-user-select: none; /* IE 10+ */
  user-select: none;

}

.caret::before {
  content: "\f104";
  color: black;
  display: inline-block;
  margin-right: 6px;
  transform: rotate(90deg);
}

.caret-down::before {
  -ms-transform: rotate(0deg); /* IE 9 */
  -webkit-transform: rotate(0deg); /* Safari */'
  transform: rotate(0deg);  
}

</style>

<i class="fas fa-angle-right"></i><span class="caret" id="caret_{{$editor_id}}" style="color: #357edd;" >隐藏代码</span>

<div id="{{$editor_id}}" style="max-width: 100%; height: 360px;border: 1px solid lightgray;"></div>

<script src="/js/ace.min/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
  var editor = ace.edit("{{$editor_id}}",{
    theme: "ace/theme/github"});
  editor.session.setMode("ace/mode/javascript");
  editor.setShowPrintMargin(false);
  editor.setAutoScrollEditorIntoView(true);
  //ContentFit($("#{{$editor_id}}"),{{$code_height}});
  $("#caret_{{$editor_id}}").on('click',(e)=>{
    var v = $("#{{$editor_id}}").css('display')
    if(v === 'none')
    {
      $("#{{$editor_id}}").css('display','block')
      $("#caret_{{$editor_id}}").removeClass('caret-down')
      $("#caret_{{$editor_id}}").text("隐藏代码")
    }
    else
    {
      $("#{{$editor_id}}").css('display','none')
      $("#caret_{{$editor_id}}").addClass('caret-down')
      $("#caret_{{$editor_id}}").text("显示代码")
    }
  });
</script>
<script type="text/javascript">
  function runeditor(editor)
  {
    console.log('run editor');

    $("#{{$id}}").children().remove();
    var code = editor.getValue();
    var mapElement = $('#{{$id}}')
    var scale = {{$height}}/720;
    var height = mapElement.width() * scale;
    mapElement.css("height",height);

    code = "function setup(){var canvas = createCanvas(" + mapElement.width() +"," + height + ");canvas.parent('{{$id}}');" + code + "}"; 
    var script = document.createElement('script');
    try {
      script.appendChild(document.createTextNode(code));
      document.body.appendChild(script);
      var editorElement = $('#{{$editor_id}}')
      editorElement.css('transform','scale(1.02)')
      setInterval(()=>{editorElement.css('transform','scale(1)')},200);
      new p5();
    } catch (e) {
      script.text = code;
      document.body.appendChild(script);
      new p5();
    }    
  }
  var editor = ace.edit("{{$editor_id}}");
  editor.setValue({{ .Inner }},1);
  
  editor.commands.addCommand({
    name:'run',
    bindKey: {win: 'Ctrl-Enter',  mac: 'Command-Enter'},
      exec: runeditor,
      readOnly: false 
  }); 
  runeditor(editor);
  window.addEventListener("resize",()=>{
    runeditor(ace.edit("{{$editor_id}}"));
  });
</script>